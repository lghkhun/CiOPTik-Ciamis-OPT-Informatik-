-- Skrip SQL Lengkap untuk Setup Database CiOPTik di Supabase
--
-- CARA MENGGUNAKAN:
-- 1. Buka dasbor proyek Supabase Anda.
-- 2. Pergi ke "SQL Editor".
-- 3. Klik "New query".
-- 4. Salin SELURUH isi file ini dan tempel ke editor.
-- 5. Klik "RUN".
--
-- Ini akan membuat semua tabel, mengisi data awal, dan mengatur kebijakan keamanan.

-- =================================================================
-- BAGIAN 1: PEMBUATAN TABEL
-- =================================================================

-- Tabel 1: opt_data (Data Utama Laporan Serangan OPT)
-- Menghapus tabel jika sudah ada untuk memastikan struktur yang bersih.
DROP TABLE IF EXISTS public.opt_data;
CREATE TABLE public.opt_data (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default now(),
    komoditas text not null check (komoditas in ('Padi', 'Palawija', 'Buah')),
    jenis_opt text not null,
    provinsi text not null default 'Jawa Barat',
    kab_kota text not null,
    tahun integer not null,
    periode text not null,
    tanggal_update date not null,
    luas_komoditas numeric(10,2) default 0,
    luas_serangan_ringan numeric(10,2) default 0,
    luas_serangan_sedang numeric(10,2) default 0,
    luas_serangan_berat numeric(10,2) default 0,
    luas_serangan_puso numeric(10,2) default 0,
    pengendalian_pm numeric(10,2) default 0,
    pengendalian_kimia numeric(10,2) default 0,
    pengendalian_nabati numeric(10,2) default 0,
    pengendalian_ah numeric(10,2) default 0,
    pengendalian_cl numeric(10,2) default 0,
    luas_terancam numeric(10,2) default 0,
    status text not null check (status in ('Not Approved', 'Approved')) default 'Not Approved'
);
COMMENT ON TABLE public.opt_data IS 'Menyimpan data laporan serangan Organisme Pengganggu Tumbuhan (OPT)';
COMMENT ON COLUMN public.opt_data.kab_kota IS 'Nama Kecamatan di Kabupaten Ciamis';

-- Tabel 2: informasi_opt (Data untuk Halaman Informasi Publik)
DROP TABLE IF EXISTS public.informasi_opt;
CREATE TABLE public.informasi_opt (
    id uuid default gen_random_uuid() primary key,
    created_at timestamp with time zone default now(),
    category text not null check (category in ('Hama', 'Penyakit')),
    title text not null,
    scientific_name text,
    image_url text,
    description text,
    details jsonb
);
COMMENT ON TABLE public.informasi_opt IS 'Menyimpan konten untuk halaman informasi OPT (hama dan penyakit)';

-- Tabel 3: feedback (Data Masukan dari Pengguna)
DROP TABLE IF EXISTS public.feedback;
CREATE TABLE public.feedback (
    id uuid default gen_random_uuid() primary key,
    created_at timestamp with time zone default now(),
    name text not null,
    email text,
    whatsapp text,
    message text not null,
    status text not null check (status in ('new', 'read')) default 'new'
);
COMMENT ON TABLE public.feedback IS 'Menyimpan feedback, saran, dan pertanyaan dari pengguna publik';

-- =================================================================
-- BAGIAN 2: PENGISIAN DATA AWAL (SEEDING)
-- =================================================================
-- PERINGATAN: Perintah di bawah ini akan menghapus semua data yang ada di tabel.
DELETE FROM public.opt_data;
DELETE FROM public.informasi_opt;
DELETE FROM public.feedback;

-- Mengisi tabel informasi_opt dengan data default
INSERT INTO public.informasi_opt (id, category, title, scientific_name, image_url, description, details)
VALUES
    ('c5c6f8f0-4c3a-4a6e-9e7b-8d9f0a1b2c3d', 'Hama', 'Penggerek Batang Padi', 'Scirpophaga innotata', 'https://i.ibb.co/6y4g3f1/penggerek-batang.jpg', 'Hama yang menyerang tanaman padi pada fase vegetatif dan generatif, menyebabkan kerusakan serius pada batang.',
    '{
        "Gejala Serangan": [{"text": "**Sundep:** Pucuk tanaman padi menjadi kering dan mati pada fase vegetatif."}, {"text": "**Beluk:** Malai padi menjadi hampa dan berwarna putih pada fase generatif."}],
        "Siklus Hidup": [{"text": "Siklus hidup terdiri dari 4 stadia: **Telur, Larva, Pupa, dan Imago (ngengat)**.", "imageUrl": null}, {"text": "Ngengat betina meletakkan telur pada daun padi. Larva yang menetas kemudian menggerek masuk ke dalam batang.", "imageUrl": null}],
        "Pengendalian": [{"text": "Pengaturan pola tanam, penggunaan varietas tahan, dan aplikasi insektisida secara bijaksana."}]
    }'),
    ('a1b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d', 'Hama', 'Wereng Batang Coklat (WBC)', 'Nilaparvata lugens', 'https://i.ibb.co/yQxG4V9/wbc.jpg', 'Hama penghisap cairan tanaman yang dapat menyebabkan tanaman menjadi kering seperti terbakar (hopperburn).',
    '{
        "Gejala Serangan": [{"text": "Tanaman menjadi kuning dan mengering. Pada serangan berat, terjadi **hopperburn**."}, {"text": "WBC juga merupakan vektor **virus kerdil rumput** dan **kerdil hampa**."}],
        "Siklus Hidup": [{"text": "Siklus hidup terdiri dari stadia **Telur, Nimfa, dan Imago**.", "imageUrl": null}],
        "Pengendalian": [{"text": "Penggunaan insektisida yang efektif, penanaman varietas tahan, dan konservasi musuh alami."}]
    }'),
    ('b2c3d4e5-f6a7-b8c9-d0e1-f2a3b4c5d6e7', 'Hama', 'Tikus Sawah', 'Rattus argentiventer', 'https://i.ibb.co/QcY9S8m/tikus.jpg', 'Hama pengerat yang merusak tanaman padi di berbagai fase pertumbuhan, dari persemaian hingga panen.',
    '{
        "Gejala Serangan": [{"text": "Batang padi terpotong, kerusakan pada malai, dan lubang-lubang aktif di pematang sawah."}],
        "Siklus Hidup": [{"text": "Tikus berkembang biak dengan cepat. Satu pasang tikus dapat menghasilkan ratusan anak dalam setahun.", "imageUrl": null}],
        "Pengendalian": [{"text": "**Gropyokan massal**, pemasangan umpan beracun (rodentisida), dan menjaga sanitasi lingkungan sawah."}]
    }'),
    ('d4e5f6a7-b8c9-d0e1-f2a3-b4c5d6e7f8a9', 'Penyakit', 'Hawar Daun Bakteri (Kresek)', 'Xanthomonas oryzae pv. oryzae', 'https://i.ibb.co/pwnxLgR/hdb.jpg', 'Penyakit yang disebabkan oleh bakteri, menyerang daun dan dapat menyebabkan kegagalan panen total.',
    '{
        "Gejala Serangan": [{"text": "Gejala **kresek** pada tanaman muda yang menyebabkan layu dan mati. Bercak kebasah-basahan dari ujung daun pada tanaman dewasa."}],
        "Mekanisme Penularan": [{"text": "Bakteri menyebar melalui air, angin, dan gesekan antar daun."}, {"text": "Masuk ke dalam jaringan tanaman melalui luka atau lubang alami (stomata)."}],
        "Pengendalian": [{"text": "Penggunaan varietas tahan, pemupukan berimbang, dan aplikasi bakterisida."}]
    }'),
    ('e5f6a7b8-c9d0-e1f2-a3b4-c5d6e7f8a9b0', 'Penyakit', 'Penyakit Blas', 'Pyricularia oryzae', 'https://i.ibb.co/yB3m5vG/blast.jpg', 'Disebabkan oleh jamur yang dapat menginfeksi semua bagian tanaman padi, terutama daun dan leher malai.',
    '{
        "Gejala Serangan": [{"text": "**Blas daun:** Bercak berbentuk belah ketupat pada daun."}, {"text": "**Blas leher (busuk leher):** Leher malai membusuk, menyebabkan malai patah dan hampa."}],
        "Mekanisme Penularan": [{"text": "Spora jamur disebarkan oleh angin, terutama pada kondisi lembab."}],
        "Pengendalian": [{"text": "Penggunaan varietas tahan, pemupukan nitrogen yang tidak berlebihan, dan aplikasi fungisida."}]
    }');

-- Mengisi tabel opt_data dengan data contoh
INSERT INTO public.opt_data
  (komoditas, jenis_opt, kab_kota, tahun, periode, tanggal_update, status, luas_serangan_ringan, luas_serangan_sedang, luas_serangan_berat, pengendalian_kimia)
VALUES
  ('Padi', 'Wereng Batang Coklat (WBC)', 'Ciamis', 2024, 'Juli (16-31)', '2024-07-20', 'Not Approved', 5.5, 1.2, 0, 2.0),
  ('Padi', 'Tikus', 'Cisaga', 2024, 'Juli (16-31)', '2024-07-22', 'Not Approved', 12.0, 3.0, 1.5, 5.0),
  ('Palawija', 'Ulat Grayak', 'Kawali', 2024, 'Agustus (1-15)', '2024-08-05', 'Approved', 2.0, 0.5, 0, 1.0),
  ('Padi', 'Blast', 'Panumbangan', 2024, 'Agustus (1-15)', '2024-08-01', 'Approved', 10.0, 2.5, 0, 4.5);

-- =================================================================
-- BAGIAN 3: PENGATURAN KEAMANAN (ROW LEVEL SECURITY - RLS)
-- =================================================================
-- CATATAN PENTING:
-- RLS secara default memblokir SEMUA akses. Kita harus membuat
-- kebijakan (policy) untuk MENGIZINKAN akses secara eksplisit.

-- --- Tabel: opt_data ---
-- 1. Aktifkan RLS
ALTER TABLE public.opt_data ENABLE ROW LEVEL SECURITY;
-- 2. Hapus kebijakan lama (jika ada) untuk memastikan kebersihan
DROP POLICY IF EXISTS "Public can view approved data" ON public.opt_data;
DROP POLICY IF EXISTS "Admin can manage all data" ON public.opt_data;
-- 3. Kebijakan untuk Publik: Hanya bisa MELIHAT (SELECT) data yang statusnya 'Approved'
CREATE POLICY "Public can view approved data" ON public.opt_data
FOR SELECT USING (status = 'Approved');
-- 4. Kebijakan untuk Admin (Pengguna Login): Bisa melakukan SEMUA AKSI (SELECT, INSERT, UPDATE, DELETE)
CREATE POLICY "Admin can manage all data" ON public.opt_data
FOR ALL USING (auth.role() = 'authenticated');

-- --- Tabel: informasi_opt ---
-- 1. Aktifkan RLS
ALTER TABLE public.informasi_opt ENABLE ROW LEVEL SECURITY;
-- 2. Hapus kebijakan lama
DROP POLICY IF EXISTS "Public can view all information" ON public.informasi_opt;
DROP POLICY IF EXISTS "Admin can manage information" ON public.informasi_opt;
-- 3. Kebijakan untuk Publik: Bisa MELIHAT semua data informasi
CREATE POLICY "Public can view all information" ON public.informasi_opt
FOR SELECT USING (true);
-- 4. Kebijakan untuk Admin: Bisa melakukan SEMUA AKSI
CREATE POLICY "Admin can manage information" ON public.informasi_opt
FOR ALL USING (auth.role() = 'authenticated');

-- --- Tabel: feedback ---
-- 1. Aktifkan RLS
ALTER TABLE public.feedback ENABLE ROW LEVEL SECURITY;
-- 2. Hapus kebijakan lama
DROP POLICY IF EXISTS "Public can insert feedback" ON public.feedback;
DROP POLICY IF EXISTS "Admin can read and update feedback" ON public.feedback;
-- 3. Kebijakan untuk Publik: Hanya bisa MENAMBAH (INSERT) data baru
CREATE POLICY "Public can insert feedback" ON public.feedback
FOR INSERT WITH CHECK (true);
-- 4. Kebijakan untuk Admin: Bisa MELIHAT dan MENGUBAH (SELECT, UPDATE)
CREATE POLICY "Admin can read and update feedback" ON public.feedback
FOR ALL USING (auth.role() = 'authenticated');

-- =================================================================
-- BAGIAN 4: PENGATURAN SUPABASE STORAGE (MANUAL)
-- =================================================================
-- CATATAN: Langkah ini harus dilakukan manual di dasbor Supabase.
-- 1. Pergi ke "Storage" di menu sebelah kiri.
-- 2. Klik "Create a new bucket".
-- 3. Beri nama bucket: "opt-images".
-- 4. Pastikan bucket diatur sebagai "Public".
-- 5. Buka bucket yang baru dibuat, pergi ke tab "Policies".
-- 6. Hapus kebijakan yang ada dan tambahkan kebijakan berikut:
--    - "Allow public read access":
--      - Target roles: anon, public
--      - Allowed operations: SELECT
--    - "Allow authenticated users to manage images":
--      - Target roles: authenticated
--      - Allowed operations: SELECT, INSERT, UPDATE, DELETE

-- Selesai! Setup database Anda sekarang lengkap.